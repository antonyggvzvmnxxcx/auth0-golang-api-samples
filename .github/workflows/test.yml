name: API Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test-01-authorization-rs256:
    runs-on: ubuntu-latest

    env:
      AUTH0_CFG: 01-Authorization-RS256
      SAMPLE_PATH: 01-Authorization-RS256

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.19"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Clone test scripts
        run: git clone --depth 1 https://github.com/auth0-samples/api-quickstarts-tests test

      - name: Prepare environment variables
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          API_IDENTIFIER: ${{ secrets.API_IDENTIFIER }}
        run: |
          cd $AUTH0_CFG
          mv .env.example .env
          sed -i 's|{DOMAIN}|'$AUTH0_DOMAIN'|g' .env
          sed -i 's|{API_IDENTIFIER}|'$API_IDENTIFIER'|g' .env

      - name: Install Go dependencies
        run: cd $AUTH0_CFG && go mod download

      - name: Build Docker image
        run: cd $AUTH0_CFG && docker build -t auth0-golang-api .

      - name: Start server in detached mode
        run: cd $AUTH0_CFG && docker run -d --env-file .env -p 3010:3010 auth0-golang-api

      - name: Wait for server to be ready
        run: |
          sleep 3
          until $(curl --silent --head --output /dev/null --fail http://localhost:3010/api/public); do
            echo "Waiting for server to start..."
            sleep 5
          done

      - name: Prepare test environment
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          API_IDENTIFIER: ${{ secrets.API_IDENTIFIER }}
          CLIENT_ID_SCOPES_NONE: ${{ secrets.CLIENT_ID_SCOPES_NONE }}
          CLIENT_SECRET_SCOPES_NONE: ${{ secrets.CLIENT_SECRET_SCOPES_NONE }}
          CLIENT_ID_SCOPES_READ: ${{ secrets.CLIENT_ID_SCOPES_READ }}
          CLIENT_SECRET_SCOPES_READ: ${{ secrets.CLIENT_SECRET_SCOPES_READ }}
          CLIENT_ID_SCOPES_WRITE: ${{ secrets.CLIENT_ID_SCOPES_WRITE }}
          CLIENT_SECRET_SCOPES_WRITE: ${{ secrets.CLIENT_SECRET_SCOPES_WRITE }}
          CLIENT_ID_SCOPES_READWRITE: ${{ secrets.CLIENT_ID_SCOPES_READWRITE }}
          CLIENT_SECRET_SCOPES_READWRITE: ${{ secrets.CLIENT_SECRET_SCOPES_READWRITE }}
        run: |
          cd test
          echo "AUTH0_DOMAIN=$AUTH0_DOMAIN" >> .env
          echo "API_IDENTIFIER=$API_IDENTIFIER" >> .env
          echo "AUTH0_CLIENT_ID_1=$CLIENT_ID_SCOPES_NONE" >> .env
          echo "AUTH0_CLIENT_SECRET_1=$CLIENT_SECRET_SCOPES_NONE" >> .env
          echo "AUTH0_CLIENT_ID_2=$CLIENT_ID_SCOPES_READ" >> .env
          echo "AUTH0_CLIENT_SECRET_2=$CLIENT_SECRET_SCOPES_READ" >> .env
          echo "AUTH0_CLIENT_ID_3=$CLIENT_ID_SCOPES_WRITE" >> .env
          echo "AUTH0_CLIENT_SECRET_3=$CLIENT_SECRET_SCOPES_WRITE" >> .env
          echo "AUTH0_CLIENT_ID_4=$CLIENT_ID_SCOPES_READWRITE" >> .env
          echo "AUTH0_CLIENT_SECRET_4=$CLIENT_SECRET_SCOPES_READWRITE" >> .env
          echo "API_URL=http://localhost:3010" >> .env
          npm install

      - name: Run automated tests
        run: cd test && npm test

  test-01-quickstart-go-api:
    runs-on: ubuntu-latest

    env:
      AUTH0_CFG: 01-Quickstart-Go-API
      SAMPLE_PATH: 01-Quickstart-Go-API

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Clone test scripts
        run: git clone --depth 1 https://github.com/auth0-samples/api-quickstarts-tests test

      - name: Prepare environment variables
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          API_IDENTIFIER: ${{ secrets.API_IDENTIFIER }}
        run: |
          cd $AUTH0_CFG
          mv .env.example .env
          sed -i 's|{DOMAIN}|'$AUTH0_DOMAIN'|g' .env
          sed -i 's|{API_IDENTIFIER}|'$API_IDENTIFIER'|g' .env

      - name: Install Go dependencies
        run: cd $AUTH0_CFG && go mod download

      - name: Build Docker image
        run: cd $AUTH0_CFG && docker build -t auth0-golang-api .

      - name: Start server in detached mode
        run: cd $AUTH0_CFG && docker run -d --env-file .env -p 8080:8080 auth0-golang-api

      - name: Wait for server to be ready
        run: |
          sleep 3
          until $(curl --silent --head --output /dev/null --fail http://localhost:8080/api/public); do
            echo "Waiting for server to start..."
            sleep 5
          done

      - name: Prepare test environment
        env:
          AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
          API_IDENTIFIER: ${{ secrets.API_IDENTIFIER }}
          CLIENT_ID_SCOPES_NONE: ${{ secrets.CLIENT_ID_SCOPES_NONE }}
          CLIENT_SECRET_SCOPES_NONE: ${{ secrets.CLIENT_SECRET_SCOPES_NONE }}
          CLIENT_ID_SCOPES_READ: ${{ secrets.CLIENT_ID_SCOPES_READ }}
          CLIENT_SECRET_SCOPES_READ: ${{ secrets.CLIENT_SECRET_SCOPES_READ }}
          CLIENT_ID_SCOPES_WRITE: ${{ secrets.CLIENT_ID_SCOPES_WRITE }}
          CLIENT_SECRET_SCOPES_WRITE: ${{ secrets.CLIENT_SECRET_SCOPES_WRITE }}
          CLIENT_ID_SCOPES_READWRITE: ${{ secrets.CLIENT_ID_SCOPES_READWRITE }}
          CLIENT_SECRET_SCOPES_READWRITE: ${{ secrets.CLIENT_SECRET_SCOPES_READWRITE }}
        run: |
          cd test
          echo "AUTH0_DOMAIN=$AUTH0_DOMAIN" >> .env
          echo "API_IDENTIFIER=$API_IDENTIFIER" >> .env
          echo "AUTH0_CLIENT_ID_1=$CLIENT_ID_SCOPES_NONE" >> .env
          echo "AUTH0_CLIENT_SECRET_1=$CLIENT_SECRET_SCOPES_NONE" >> .env
          echo "AUTH0_CLIENT_ID_2=$CLIENT_ID_SCOPES_READ" >> .env
          echo "AUTH0_CLIENT_SECRET_2=$CLIENT_SECRET_SCOPES_READ" >> .env
          echo "AUTH0_CLIENT_ID_3=$CLIENT_ID_SCOPES_WRITE" >> .env
          echo "AUTH0_CLIENT_SECRET_3=$CLIENT_SECRET_SCOPES_WRITE" >> .env
          echo "AUTH0_CLIENT_ID_4=$CLIENT_ID_SCOPES_READWRITE" >> .env
          echo "AUTH0_CLIENT_SECRET_4=$CLIENT_SECRET_SCOPES_READWRITE" >> .env
          echo "API_URL=http://localhost:8080" >> .env
          npm install

      - name: Run automated tests
        run: cd test && npm test
